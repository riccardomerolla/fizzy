<% @page_title = "Reprocessing Cycles" %>

<div class="panel panel--wide">
  <div class="flex gap justify-between align-center margin-block-end">
    <h1 class="txt-x-large margin-none font-weight-black"><%= @page_title %></h1>
    <div class="flex gap">
      <%= link_to "Export CSV", reprocessing_cycles_path(format: :csv, site_id: params[:site_id], status: params[:status], start_date: params[:start_date], end_date: params[:end_date]), class: "btn" %>
      <%= link_to "Dashboard", dashboard_path, class: "btn btn--primary" %>
    </div>
  </div>

  <!-- Filters -->
  <div class="margin-block-end">
    <%= form_with url: reprocessing_cycles_path, method: :get, class: "flex gap align-end" do |form| %>
      <div class="flex flex-column gap-small">
        <%= form.label :site_id, "Site" %>
        <%= form.select :site_id, 
            options_for_select([["All Sites", ""]] + Current.account.sites.alphabetically.map { |s| [s.name, s.id] }, params[:site_id]),
            {}, class: "input" %>
      </div>

      <div class="flex flex-column gap-small">
        <%= form.label :status, "Status" %>
        <%= form.select :status, 
            options_for_select([["All", ""], ["Conform", "conform"], ["Non-Conform", "nonconform"]], params[:status]),
            {}, class: "input" %>
      </div>

      <div class="flex flex-column gap-small">
        <%= form.label :start_date, "Start Date" %>
        <%= form.date_field :start_date, value: params[:start_date], class: "input" %>
      </div>

      <div class="flex flex-column gap-small">
        <%= form.label :end_date, "End Date" %>
        <%= form.date_field :end_date, value: params[:end_date], class: "input" %>
      </div>

      <%= form.submit "Filter", class: "btn btn--primary" %>
    <% end %>
  </div>

  <% if @cycles.any? %>
    <table class="full-width margin-block-start">
      <thead>
        <tr>
          <th>Cycle</th>
          <th>Site</th>
          <th>Set Catalog</th>
          <th>Status</th>
          <th>Received</th>
          <th>Sterilized</th>
          <th>Turnaround</th>
          <th>Non-Conformities</th>
        </tr>
      </thead>
      <tbody>
        <% @cycles.each do |cycle| %>
          <tr>
            <td><code><%= cycle.cycle_barcode %></code></td>
            <td><%= cycle.site.name %></td>
            <td><%= cycle.set_catalog.name %></td>
            <td>
              <% if cycle.conform? %>
                <span class="badge badge--success">Conform</span>
              <% else %>
                <span class="badge badge--danger">Non-Conform</span>
              <% end %>
            </td>
            <td><%= time_tag cycle.received_at, format: :short %></td>
            <td>
              <% if cycle.sterilized_at %>
                <%= time_tag cycle.sterilized_at, format: :short %>
              <% else %>
                <span class="txt-muted">—</span>
              <% end %>
            </td>
            <td>
              <% if cycle.turnaround_hours %>
                <%= number_with_precision(cycle.turnaround_hours, precision: 1) %>h
              <% else %>
                <span class="txt-muted">—</span>
              <% end %>
            </td>
            <td>
              <% if cycle.non_conformities.any? %>
                <%= cycle.non_conformities.map(&:kind).map(&:titleize).join(", ") %>
              <% else %>
                <span class="txt-muted">—</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <% if @cycles.respond_to?(:total_pages) %>
      <div class="pagination margin-block-start">
        <%= paginate @cycles %>
      </div>
    <% end %>
  <% else %>
    <div class="blank-slate margin-block-start-large">
      <p class="txt-large">No reprocessing cycles found.</p>
      <%= link_to "Import CSV", sites_path, class: "btn btn--primary margin-block-start" %>
    </div>
  <% end %>
</div>
