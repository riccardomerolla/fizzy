<% @page_title = "Non-Conformities" %>

<% content_for :header do %>
  <h1 class="header__title divider divider--fade full-width">
    <span class="overflow-ellipsis"><%= @page_title %></span>
  </h1>

  <div class="header__actions header__actions--end">
    <%= link_to non_conformities_path(format: :csv, **params.permit(:search, :site_id, :kind, :start_date, :end_date)), class: "btn btn--circle", data: { controller: "tooltip" } do %>
      <%= icon_tag "share" %>
      <span class="for-screen-reader">Export CSV</span>
    <% end %>
  </div>
<% end %>

<% expanded = ActiveRecord::Type::Boolean.new.cast(params[:expand_all]) %>
<%= tag.aside class: class_names("filters margin-block-end", { "filters--expanded": expanded }),
    data: {
      controller: "toggle-enable toggle-class",
      toggle_class_toggle_class: "filters--expanded",
      turbo_permanent: true } do %>
  <%= form_with url: non_conformities_path, method: :get, class: "display-contents", data: {
        controller: "form",
        action: "submit->form#submit" } do |form| %>
    <%= hidden_field_tag :expand_all, true, disabled: !expanded, data: { toggle_enable_target: "element" } %>

    <%= form.search_field :search, placeholder: "Filter non-conformities… [F]", value: params[:search], class: "filter__terms input txt-x-small",
        autofocus: false, autocomplete: :off, autocorrect: "off", data: {
              "1p-ignore": "true",
              controller: "hotkey",
              action: "keydown.f@document->hotkey#focus input->form#debouncedSubmit keydown.enter->form#submit blur->form#submit" } %>

    <%= form.select :site_id,
        options_for_select([["All Sites", ""]] + Current.account.sites.alphabetically.map { |s| [s.name, s.id] }, params[:site_id]),
        {},
        class: "btn input input--select txt-x-small filters__show-when-expanded",
        style: "max-width: 12em;",
        data: { action: "change->form#submit" } %>

    <%= form.select :kind,
        options_for_select([["All Types", ""]] + NonConformity::KINDS.map { |k| [k.titleize, k] }, params[:kind]),
        {},
        class: "btn input input--select txt-x-small filters__show-when-expanded",
        style: "max-width: 12em;",
        data: { action: "change->form#submit" } %>

    <%= form.date_field :start_date,
        value: params[:start_date],
        placeholder: "Start date",
        class: "btn input input--select txt-x-small filters__show-when-expanded",
        style: "max-width: 10em;",
        data: { action: "change->form#submit" } %>

    <%= form.date_field :end_date,
        value: params[:end_date],
        placeholder: "End date",
        class: "btn input input--select txt-x-small filters__show-when-expanded",
        style: "max-width: 10em;",
        data: { action: "change->form#submit" } %>

    <% if expanded %>
      <button type="button" class="btn txt-x-small btn--reversed" aria-selected="true" data-action="toggle-class#toggle toggle-enable#toggle" data-controller="tooltip">
        <%= icon_tag "filter" %>
        <span class="for-screen-reader">Close filter options</span>
      </button>
    <% else %>
      <button type="button" class="btn txt-x-small filter-toggle" data-action="toggle-class#toggle toggle-enable#toggle" data-controller="tooltip">
        <%= icon_tag "filter" %>
        <span class="filters__show-when-expanded for-screen-reader">Collapse filter options</span>
        <span class="filters__show-when-collapsed for-screen-reader">Expand filter options</span>
      </button>
    <% end %>
  <% end %>
<% end %>

<!-- Pareto Summary -->
<section class="panel shadow margin-block-start-half" style="--panel-size: 100%;">
  <% if @pareto_summary.any? %>
    <header>
      <h2 class="divider txt-large">Non-Conformity Breakdown (Pareto)</h2>
    </header>
    <table class="full-width margin-block-start">
      <thead>
        <tr>
          <th>Type</th>
          <th>Count</th>
          <th>Visual</th>
        </tr>
      </thead>
      <tbody>
        <% total = @pareto_summary.sum { |_k, v| v } %>
        <% @pareto_summary.take(10).each do |kind, count| %>
          <% percentage = (count.to_f / total * 100).round(1) %>
          <tr>
            <td><strong><%= kind.titleize %></strong></td>
            <td><%= count %> (<%= number_to_percentage(percentage, precision: 1) %>)</td>
            <td>
              <div style="background: #e74c3c; height: 20px; width: <%= percentage %>%; max-width: 100%;"></div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <div class="blank-slate">
      <p class="txt-large">No non-conformities to analyze.</p>
    </div>
  <% end %>
</section>

<!-- Non-Conformities List -->
<section class="panel shadow margin-block-start-half" style="--panel-size: 100%;">
  <% if @non_conformities.any? %>
    <table class="full-width margin-block-start">
      <thead>
        <tr>
          <th>Occurred At</th>
          <th>Type</th>
          <th>Site</th>
          <th>Cycle Barcode</th>
          <th>Set Catalog</th>
          <th>Notes</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% @non_conformities.each do |nc| %>
          <% cycle = nc.reprocessing_cycle %>
          <tr>
            <td class="txt-small"><%= time_tag(nc.occurred_at, format: :short) %></td>
            <td>
              <span class="label label--danger"><%= nc.kind.titleize %></span>
            </td>
            <td><%= cycle.site.name %></td>
            <td><code><%= cycle.cycle_barcode %></code></td>
            <td><%= cycle.set_catalog.name %></td>
            <td class="txt-small"><%= nc.notes.present? ? truncate(nc.notes, length: 50) : "—" %></td>
            <td>
              <% if cycle.status == "conform" %>
                <span class="label label--success">Conform</span>
              <% else %>
                <span class="label label--danger">Nonconform</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <!-- Pagination handled via .page() method on controller side -->
  <% else %>
    <div class="blank-slate">
      <p class="txt-large">No non-conformities found matching your filters.</p>
      <%= link_to "Clear Filters", non_conformities_path, class: "btn btn--link center margin-block-start" %>
    </div>
  <% end %>
</section>
