<% @page_title = "Compute Invoice" %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to "Invoice Periods", contract_invoice_periods_path(@contract), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>

  <h1 class="header__title divider divider--fade full-width"><%= @page_title %></h1>
<% end %>

<section class="panel shadow center margin-block-start-half">
  <div class="panel panel--inset margin-block-end">
    <h2 class="txt-large margin-none margin-block-end-small">Contract: <%= @contract.name %></h2>
    <p class="txt-subtle margin-none">
      Site: <%= @contract.site&.name || "All Sites" %><br>
      Price per set: <%= number_to_currency(@contract.price_per_set_cents / 100.0) %><br>
      Exclude nonconform: <%= @contract.exclude_nonconform? ? "Yes" : "No" %><br>
      <% if @contract.sla_turnaround_hours.present? %>
        SLA: <%= @contract.sla_turnaround_hours %> hours (Penalty: <%= number_to_currency((@contract.penalty_per_breach_cents || 0) / 100.0) %>)
      <% else %>
        SLA: Not configured
      <% end %>
    </p>
  </div>

  <%= form_with model: @invoice_period, url: contract_invoice_periods_path(@contract), class: "flex flex-column gap" do |form| %>
    <% if @invoice_period.errors.any? %>
      <div class="panel panel--inset panel--danger">
        <h2 class="txt-large margin-none margin-block-end-small"><%= pluralize(@invoice_period.errors.count, "error") %> prevented this invoice from being computed:</h2>
        <ul class="margin-none">
          <% @invoice_period.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="flex gap">
      <div class="flex flex-column gap-small flex-1">
        <%= form.label :year, "Year" %>
        <%= form.number_field :year, class: "input", min: 2020, max: 2050 %>
      </div>

      <div class="flex flex-column gap-small flex-1">
        <%= form.label :month, "Month" %>
        <%= form.select :month, 
            options_for_select((1..12).map { |m| [Date::MONTHNAMES[m], m] }, @invoice_period.month),
            {}, class: "input" %>
      </div>
    </div>

    <p class="txt-small txt-subtle">
      The invoice will be computed based on reprocessing cycles with <strong>sterilized_at</strong> timestamps in the selected month.
    </p>

    <div class="flex gap margin-block-start">
      <button type="submit" class="btn btn--link center">
        <span>Compute Invoice</span>
        <%= icon_tag "arrow-right" %>
      </button>
      <%= link_to "Cancel", contract_invoice_periods_path(@contract), class: "btn", data: { turbo_frame: "_top" } %>
    </div>
  <% end %>
</section>
